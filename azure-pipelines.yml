# TP05 - Azure DevOps CI/CD Pipeline - AplicaciÃ³n Palabras (Node.js)
# Basado en arquitectura similar: Backend (Node.js) + Frontend (HTML/JS estÃ¡ticos)

trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - '*'

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '20.x'
  azureSubscription: 'azure-palabras-connection'
  webAppNameQA: 'palabras-qa'

stages:
# =======================================
# ğŸ§± BUILD & TEST
# =======================================
- stage: BuildAndTest
  displayName: "Build & Test Backend + Frontend"
  jobs:
    - job: BuildAndTest
      displayName: 'Build and Test Job'
      steps:
        - checkout: self

        # ---- Setup Node.js ----
        - task: NodeTool@0
          displayName: "Setup Node.js $(nodeVersion)"
          inputs:
            versionSpec: "$(nodeVersion)"

        # ---- Backend (Node.js + Express) ----
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND BUILD"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm ci
            npm run build
            echo "âœ… Backend build completed"
          displayName: "Build Backend"

        # ---- Frontend (Static HTML/JS) ----
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND BUILD"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            # Frontend no requiere build, solo verificaciÃ³n
            if [ -f "package.json" ]; then
              npm ci --if-present
              npm run build --if-present
            fi
            echo "âœ… Frontend ready"
          displayName: "Prepare Frontend"

        # ---- Copiar Frontend al Backend (como wwwroot) ----
        - task: CopyFiles@2
          displayName: 'Copy Frontend to Backend wwwroot'
          inputs:
            SourceFolder: 'frontend'
            Contents: |
              index.html
              app.js
              styles.css
            TargetFolder: 'backend/frontend'
            OverWrite: true

        # ---- Publicar Backend + Frontend juntos ----
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  PREPARING PUBLISH PACKAGE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            mkdir -p "$(Build.ArtifactStagingDirectory)/publish"
            
            # Copiar backend completo
            cp backend/index.js "$(Build.ArtifactStagingDirectory)/publish/"
            cp backend/package.json "$(Build.ArtifactStagingDirectory)/publish/"
            cp backend/package-lock.json "$(Build.ArtifactStagingDirectory)/publish/"
            cp -r backend/node_modules "$(Build.ArtifactStagingDirectory)/publish/"
            
            # Copiar frontend que ya estÃ¡ dentro de backend
            cp -r backend/frontend "$(Build.ArtifactStagingDirectory)/publish/"
            
            # Copiar DB si existe
            if [ -f "backend/palabras.db" ]; then
              cp backend/palabras.db "$(Build.ArtifactStagingDirectory)/publish/"
            fi
            
            echo ""
            echo "âœ… Package structure:"
            ls -lah "$(Build.ArtifactStagingDirectory)/publish/"
            echo ""
            echo "ğŸ“ Frontend files:"
            ls -lah "$(Build.ArtifactStagingDirectory)/publish/frontend/"
            echo ""
            echo "ğŸ“„ Backend index.js (first 5 lines):"
            head -n 5 "$(Build.ArtifactStagingDirectory)/publish/index.js"
          displayName: "Publish Backend+Frontend"

        # ---- Publicar Artefacto ----
        - task: PublishBuildArtifacts@1
          displayName: "Publish Build Artifact"
          inputs:
            PathtoPublish: "$(Build.ArtifactStagingDirectory)/publish"
            ArtifactName: "drop"
            publishLocation: 'Container'

# =======================================
# ğŸŒ DEPLOY QA
# =======================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: BuildAndTest
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
    - deployment: DeployQA
      displayName: "Desplegar QA"
      environment: "QA"
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
              
              - download: current
                artifact: drop

              - task: AzureWebApp@1
                displayName: "Deploy Backend+Frontend QA"
                inputs:
                  azureSubscription: "$(azureSubscription)"
                  appType: 'webAppLinux'
                  appName: "$(webAppNameQA)"
                  package: "$(Pipeline.Workspace)/drop"
                  runtimeStack: 'NODE|20-lts'
                  startUpCommand: 'node index.js'

              # Health Check
              - script: |
                  echo "â³ Esperando 30 segundos para que la app inicie..."
                  sleep 30
                  echo "ğŸ” Verificando QA deployment..."
                  curl -f https://$(webAppNameQA).brazilsouth-01.azurewebsites.net/health || echo "âš ï¸ Health check pending"
                displayName: "Health Check QA"
                continueOnError: true